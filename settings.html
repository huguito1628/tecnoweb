<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuraciones - Abba Jhire Corporation</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="dashboard.css" />

  <style>
    body { display: none; }

    .setting-card {
      background-color: #2b2d30;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 20px;
      height: 100%;
      transition: all 0.3s ease;
    }

    .setting-card:hover {
      transform: translateY(-4px);
      border-color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .form-control, .form-select {
      background-color: #1e1e1e;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .form-switch .form-check-input {
      background-color: #444;
      border-color: rgba(255,255,255,0.3);
    }

    .form-switch .form-check-input:checked {
      background-color: #0d6efd;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1050; }
      .sidebar.show-sidebar { transform: translateX(0); }
      .main-content { margin-left: 0; }
      #closeSidebar { position: absolute; top: 10px; right: 10px; z-index: 1100; }
    }
    @media (min-width: 769px) {
      .main-content { margin-left: 250px; }
      .sidebar { width: 250px; }
    }
  </style>

  <script>
    // Protecci√≥n de sesi√≥n b√°sica (redirige si no hay sesi√≥n v√°lida)
    const sessionActive = localStorage.getItem('sessionActive');
    const sessionUser = localStorage.getItem('sessionUser');
    if (sessionActive !== 'true' || !sessionUser) {
      window.location.href = 'auth.html';
    } else {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.style.display = 'block';
      });
    }
  </script>
</head>

<body class="bg-dark text-light">
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar bg-dark position-fixed h-100" id="sidebar">
      <button class="btn btn-light d-md-none m-2" id="closeSidebar">
        <i class="bi bi-x-lg fs-4"></i>
      </button>

      <div class="brand mt-4 text-center">
        <h2>ABBA<br><span>JHIRE</span></h2>
      </div>

      <ul class="menu">
        <li><a href="index.html" class="menu-link"><i class="bi bi-speedometer2"></i> <span>Inicio</span></a></li>
        <li><a href="users.html" class="menu-link"><i class="bi bi-people"></i> <span>Usuarios</span></a></li>
        <li><a href="inventory.html" class="menu-link"><i class="bi bi-box-seam"></i> <span>Inventario</span></a></li>
        <li><a href="reports.html" class="menu-link"><i class="bi bi-bar-chart"></i> <span>Reportes</span></a></li>
        <li class="active"><a href="settings.html" class="menu-link"><i class="bi bi-gear"></i> <span>Configuraci√≥n</span></a></li>
      </ul>

      <button id="logoutBtn" class="logout-btn"><i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n</button>
    </aside>

    <!-- Contenido principal -->
    <main class="main-content">
      <header class="topbar d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-light d-md-none" id="menuToggle"><i class="bi bi-list fs-2"></i></button>
        <h3 class="mb-0"><i class="bi bi-gear"></i> Configuraci√≥n del Usuario</h3>
      </header>

      <section class="content-section mt-4">
        <div class="container-fluid">
          <div class="row g-4">

            <!-- Perfil -->
            <div class="col-12 col-lg-6">
              <div class="setting-card">
                <h5><i class="bi bi-person-circle"></i> Preferencias de Usuario</h5>
                <p class="text-secondary">Administra tu informaci√≥n personal y c√≥mo apareces en el sistema.</p>

                <div class="text-center mb-3">
                  <img src="images/default-user.jpg" alt="Foto de perfil" class="rounded-circle" width="90" height="90" id="profilePreview">
                </div>

                <div class="mb-3">
                  <label class="form-label">Cambiar foto de perfil</label>
                  <input type="file" class="form-control" id="profileImage" accept="image/*">
                </div>

                <div class="mb-3">
                  <label class="form-label">Nombre visible</label>
                  <input type="text" class="form-control" id="displayName" placeholder="Tu nombre visible">
                </div>

                <div class="mb-3">
                  <label class="form-label">Cargo preferido</label>
                  <select class="form-select" id="preferredRole">
                    <option>Administrador</option>
                    <option>Supervisor</option>
                    <option>Vendedor</option>
                    <option>Soporte T√©cnico</option>
                  </select>
                </div>

                <button class="btn btn-light w-100" id="saveProfileBtn">Guardar Cambios</button>
              </div>
            </div>

            <!-- Seguridad -->
            <div class="col-12 col-lg-6">
              <div class="setting-card">
                <h5><i class="bi bi-shield-lock"></i> Seguridad y Acceso</h5>
                <p class="text-secondary">Verifica tu identidad antes de actualizar la contrase√±a.</p>

                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="twoFactor" checked>
                  <label class="form-check-label" for="twoFactor">Activar verificaci√≥n en dos pasos</label>
                </div>

                <div class="form-check form-switch mb-4">
                  <input class="form-check-input" type="checkbox" id="autoLock">
                  <label class="form-check-label" for="autoLock">Bloqueo autom√°tico tras inactividad</label>
                </div>

                <form id="passwordForm">
                  <label class="form-label">Contrase√±a actual</label>
                  <input type="password" id="currentPass" class="form-control mb-2" placeholder="Contrase√±a actual" required>

                  <label class="form-label">Nueva contrase√±a</label>
                  <input type="password" id="newPass" class="form-control mb-2" placeholder="Nueva contrase√±a" required>

                  <label class="form-label">Confirmar nueva contrase√±a</label>
                  <input type="password" id="confirmPass" class="form-control mb-3" placeholder="Confirmar contrase√±a" required>

                  <button type="submit" class="btn btn-outline-light w-100">Actualizar Contrase√±a</button>
                </form>
              </div>
            </div>

            <!-- Notificaciones -->
            <div class="col-12 col-lg-6">
              <div class="setting-card">
                <h5><i class="bi bi-bell"></i> Notificaciones</h5>
                <p class="text-secondary">Personaliza las alertas que recibir√°s.</p>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="notifUsers" checked>
                  <label class="form-check-label" for="notifUsers">Nuevos usuarios agregados</label>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="notifStock" checked>
                  <label class="form-check-label" for="notifStock">Avisos de stock bajo</label>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="notifReports">
                  <label class="form-check-label" for="notifReports">Resumen semanal de reportes</label>
                </div>
              </div>
            </div>

            <!-- Privacidad -->
            <div class="col-12 col-lg-6">
              <div class="setting-card">
                <h5><i class="bi bi-eye-slash"></i> Privacidad</h5>
                <p class="text-secondary">Controla tu visibilidad dentro del sistema.</p>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="showOnlineStatus" checked>
                  <label class="form-check-label" for="showOnlineStatus">Mostrar mi estado ‚ÄúEn l√≠nea‚Äù</label>
                </div>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="showActivity">
                  <label class="form-check-label" for="showActivity">Mostrar mi actividad reciente</label>
                </div>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="hideSensitive">
                  <label class="form-check-label" for="hideSensitive">Ocultar datos sensibles por defecto</label>
                </div>
              </div>
            </div>

            <!-- Sesi√≥n e Inactividad -->
            <div class="col-12">
              <div class="setting-card">
                <h5><i class="bi bi-clock-history"></i> Sesi√≥n e Inactividad</h5>
                <p class="text-secondary">Configura cu√°nto tiempo puede estar abierta la sesi√≥n sin actividad. Si "Bloqueo autom√°tico" est√° activado, la sesi√≥n se cerrar√° cuando expire el tiempo.</p>

                <div class="row g-3 align-items-center">
                  <div class="col-md-3">
                    <label class="form-label">Tiempo (min)</label>
                    <select id="sessionTimeout" class="form-select">
                      <option value="1">1</option>
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="30">30</option>
                    </select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Advertencia (seg)</label>
                    <input type="number" id="warningSeconds" class="form-control" min="5" value="30" title="Segundos antes de cerrar sesi√≥n para avisar">
                  </div>

                  <div class="col-md-6 d-grid">
                    <button class="btn btn-light w-100" id="saveSessionSettings">Guardar Configuraci√≥n</button>
                  </div>
                </div>

                <div class="mt-3">
                  <small class="text-secondary">√öltima actividad: <span id="lastActivity">ahora</span></small>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal de advertencia antes de cerrar sesi√≥n -->
  <div class="modal fade" id="sessionWarningModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Advertencia de Inactividad</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">No se detect√≥ actividad. La sesi√≥n se cerrar√° en <strong id="countdownWarn">30</strong> segundos, a menos que interact√∫es con la p√°gina.</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="stayLoggedBtn">Permanecer conectado</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- ELEMENTOS ----------
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menuToggle");
    const closeSidebar = document.getElementById("closeSidebar");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const profileImageInput = document.getElementById("profileImage");
    const profilePreview = document.getElementById("profilePreview");
    const saveSessionSettingsBtn = document.getElementById("saveSessionSettings");
    const sessionTimeoutSelect = document.getElementById("sessionTimeout");
    const autoLockCheckbox = document.getElementById("autoLock");
    const lastActivityLabel = document.getElementById("lastActivity");
    const warningSecondsInput = document.getElementById("warningSeconds");
    const sessionWarningModal = new bootstrap.Modal(document.getElementById('sessionWarningModal'));
    const countdownWarnEl = document.getElementById('countdownWarn');
    const stayLoggedBtn = document.getElementById('stayLoggedBtn');

    // ---------- SIDEBAR ----------
    menuToggle.addEventListener("click", () => sidebar.classList.add("show-sidebar"));
    closeSidebar.addEventListener("click", () => sidebar.classList.remove("show-sidebar"));

    // ---------- PERFIL PREVIEW ----------
    profileImageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => profilePreview.src = ev.target.result;
        reader.readAsDataURL(file);
      }
    });

    saveProfileBtn.addEventListener("click", () => {
      const name = document.getElementById("displayName").value;
      // Aqu√≠ podr√≠as guardar en backend o localStorage
      alert(`‚úÖ Perfil actualizado. Bien hecho, ${name || "usuario"}!`);
    });

    // ---------- CONTRASE√ëA (verificaci√≥n actual) ----------
    // Simulaci√≥n: contrase√±a almacenada en localStorage (solo demo)
    if (!localStorage.getItem("userPassword")) localStorage.setItem("userPassword", "admin123");

    document.getElementById("passwordForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const current = document.getElementById("currentPass").value;
      const newPass = document.getElementById("newPass").value;
      const confirm = document.getElementById("confirmPass").value;
      const stored = localStorage.getItem("userPassword");

      if (current !== stored) {
        alert("‚ùå La contrase√±a actual es incorrecta.");
        return;
      }
      if (newPass !== confirm) {
        alert("‚ùå Las contrase√±as nuevas no coinciden.");
        return;
      }

      localStorage.setItem("userPassword", newPass);
      alert("üîê Contrase√±a actualizada correctamente.");
      e.target.reset();
    });

    // ---------- NOTIFICACIONES & PRIVACIDAD (placeholders) ----------
    // Las opciones son guardadas localmente si quieres persistirlas
    document.getElementById("notifUsers").addEventListener("change", (e) => localStorage.setItem("notifUsers", e.target.checked));
    document.getElementById("notifStock").addEventListener("change", (e) => localStorage.setItem("notifStock", e.target.checked));
    document.getElementById("notifReports").addEventListener("change", (e) => localStorage.setItem("notifReports", e.target.checked));
    document.getElementById("showOnlineStatus").addEventListener("change", (e) => localStorage.setItem("showOnlineStatus", e.target.checked));
    document.getElementById("showActivity").addEventListener("change", (e) => localStorage.setItem("showActivity", e.target.checked));
    document.getElementById("hideSensitive").addEventListener("change", (e) => localStorage.setItem("hideSensitive", e.target.checked));
    document.getElementById("twoFactor").addEventListener("change", (e) => localStorage.setItem("twoFactor", e.target.checked));
    document.getElementById("notifUsers").checked = localStorage.getItem("notifUsers") === "true" || true; // default true
    document.getElementById("notifStock").checked = localStorage.getItem("notifStock") === "true" || true; // default true
    document.getElementById("notifReports").checked = localStorage.getItem("notifReports") === "true";

    // ---------- SESI√ìN E INACTIVIDAD ----------
    // Par√°metros y timer
    let sessionTimer = null;
    let warningTimer = null;
    let countdownInterval = null;

    // Cargar preferencia guardada (si existe)
    function loadSessionSettings() {
      const savedTimeout = localStorage.getItem("sessionTimeout");
      const savedAutoLock = localStorage.getItem("autoLock");
      const savedWarning = localStorage.getItem("warningSeconds");

      if (savedTimeout) sessionTimeoutSelect.value = savedTimeout;
      if (savedAutoLock === "true") autoLockCheckbox.checked = true;
      if (savedWarning) warningSecondsInput.value = savedWarning;
    }

    loadSessionSettings();

    // Actualiza etiqueta de √∫ltima actividad
    function updateLastActivityLabel() {
      const now = new Date();
      lastActivityLabel.textContent = now.toLocaleString();
    }

    // Crea / reinicia temporizador de sesi√≥n
    function startSessionTimer() {
      clearSessionTimer();

      const minutes = parseInt(sessionTimeoutSelect.value, 10) || 10;
      const ms = minutes * 60 * 1000;
      const warningSec = parseInt(warningSecondsInput.value, 10) || 30;
      const autoLock = autoLockCheckbox.checked;

      // Solo activa comportamiento si autoLock est√° activado
      if (!autoLock) return;

      // Timer principal: al expirar, cerramos sesi√≥n
      sessionTimer = setTimeout(() => {
        // Si hay una advertencia configurada, mostramos modal y damos warningSec para reaccionar
        if (warningSec > 0) {
          let remaining = warningSec;
          countdownWarnEl.textContent = remaining;
          sessionWarningModal.show();

          // Cuenta regresiva visible
          countdownInterval = setInterval(() => {
            remaining -= 1;
            countdownWarnEl.textContent = remaining;
            if (remaining <= 0) {
              clearInterval(countdownInterval);
            }
          }, 1000);

          // Despu√©s de warningSec seg, cerrar sesi√≥n si sigue sin actividad
          warningTimer = setTimeout(() => {
            sessionWarningModal.hide();
            doAutoLogout();
          }, warningSec * 1000);
        } else {
          // Sin advertencia: cerrar sesi√≥n ya mismo
          doAutoLogout();
        }
      }, ms - (warningSec * 1000)); // lanzamos el aviso con suficiente antelaci√≥n
    }

    function resetSessionTimer() {
      updateLastActivityLabel();
      // Si usuario interact√∫a mientras modal de advertencia est√° visible, lo detenemos
      if (sessionWarningModal._isShown) {
        // si estaba a punto de cerrar, cancelamos y reiniciamos
        clearTimeout(warningTimer);
        clearInterval(countdownInterval);
        sessionWarningModal.hide();
      }
      clearSessionTimer();
      startSessionTimer();
    }

    function clearSessionTimer() {
      if (sessionTimer) { clearTimeout(sessionTimer); sessionTimer = null; }
      if (warningTimer) { clearTimeout(warningTimer); warningTimer = null; }
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
    }

    function doAutoLogout() {
      // Cierra sesi√≥n: limpia flags y redirige a auth.html
      localStorage.removeItem('sessionActive');
      localStorage.removeItem('sessionUser');
      alert('Tu sesi√≥n ha sido cerrada por inactividad.');
      window.location.href = 'auth.html';
    }

    // Guardar ajustes de sesi√≥n
    saveSessionSettingsBtn.addEventListener("click", () => {
      localStorage.setItem("sessionTimeout", sessionTimeoutSelect.value);
      localStorage.setItem("autoLock", autoLockCheckbox.checked);
      localStorage.setItem("warningSeconds", warningSecondsInput.value);
      alert(`‚úÖ Configuraci√≥n de sesi√≥n guardada: ${sessionTimeoutSelect.value} min. Bloqueo autom√°tico: ${autoLockCheckbox.checked ? 'S√≠' : 'No'}.`);
      // Reiniciar temporizador con nuevas opciones
      resetSessionTimer();
    });

    // Reset del temporizador al pulsar "Permanecer conectado"
    stayLoggedBtn.addEventListener("click", () => {
      resetSessionTimer();
    });

    // Detectar actividad del usuario para reiniciar el temporizador
    ['mousemove','mousedown','keypress','touchstart','click'].forEach(ev => {
      document.addEventListener(ev, () => {
        // solo reiniciamos si autoLock est√° activado
        if (autoLockCheckbox.checked) resetSessionTimer();
      }, { passive: true });
    });

    // Cambiar autoLock reinicia o detiene comportamiento
    autoLockCheckbox.addEventListener("change", () => {
      localStorage.setItem("autoLock", autoLockCheckbox.checked);
      if (autoLockCheckbox.checked) startSessionTimer();
      else clearSessionTimer();
    });

    // Inicializar √∫ltima actividad y temporizador al cargar p√°gina
    updateLastActivityLabel();
    if (autoLockCheckbox.checked) startSessionTimer();

    // Antes de abandonar la pesta√±a (ej. cerrar o recargar), actualizamos lastActivity (opcional)
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("lastActivity", new Date().toISOString());
    });

    // ---------- Inicializaci√≥n de valores guardados (otros ajustes) ----------
    // Privacidad / notificaciones / twoFactor
    if (localStorage.getItem("twoFactor") === "true") document.getElementById("twoFactor").checked = true;
    if (localStorage.getItem("showOnlineStatus") === "false") document.getElementById("showOnlineStatus").checked = false;
    if (localStorage.getItem("showActivity") === "true") document.getElementById("showActivity").checked = true;
    if (localStorage.getItem("hideSensitive") === "true") document.getElementById("hideSensitive").checked = true;

  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById('logoutBtn');

    // Cerrar sesi√≥n
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('sessionActive');
        localStorage.removeItem('sessionUser');
        window.location.href = 'auth.html';
      });
    }
  });
</script>

</body>
</html>
